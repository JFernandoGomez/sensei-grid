/**
 * sensei-grid v0.2.0
 * Copyright (c) 2014 Lauris Dzilums <lauris@discuss.lv>
 * Licensed under MIT 
*/
!function(a){a.fn.grid=function(b,c,d){function e(a){var b=a.get(0),c=b.style.display;b.style.display="none",b.offsetHeight,b.style.display=c}var f=this,g={emptyRow:!1,sortable:!0,tableClass:"table table-bordered table-condensed"};return f.isEditing=!1,f.$prevRow=null,a.fn.isOnScreen=function(){var b=a(window),c={top:b.scrollTop(),left:b.scrollLeft()};c.right=c.left+b.width(),c.bottom=c.top+b.height();var d=this.offset();return d.right=d.left+this.outerWidth(),d.bottom=d.top+this.outerHeight(),!(c.right<d.left||c.left>d.right||c.bottom<d.top||c.top>d.bottom)},a.fn.setActiveCell=function(){f.$prevRow=a("tr>.activeCell",f.$el).parent("tr"),f.$prevRow.removeClass("activeRow"),a("tr>.activeCell",f.$el).removeClass("activeCell"),a(this).addClass("activeCell"),a(this).parent("tr").addClass("activeRow"),e(a(this).parent("tr")),f.events.trigger("cell:select",a(this)),f.$prevRow.index()!==a(this).parent("tr").index()&&(f.events.trigger("row:select",a(this).parent("tr")),f.$prevRow.hasClass("sensei-grid-dirty-row")&&f.isEditing&&f.events.trigger("row:save",f.getRowData(f.$prevRow),f.$prevRow,"row:select"))},a.fn.cellPosition=function(){var b=a(this).position();return f.isSillyFirefox()&&(b.left-=1,b.top-=1),b},f.events={_events:{}},f.events.on=function(a,b,c){_.has(this._events,a)||(this._events[a]=[]),this._events[a].push({callback:b,context:c})},f.events.trigger=function(a){var b=Array.prototype.slice.call(arguments,1);if(_.has(this._events,a)){var c=this._events[a];_.each(c,function(a){var c=_.bind(a.callback,a.context);c.apply(this,b)})}},f.events.off=function(a){_.has(this._events,a)&&delete this._events[a]},f.isSillyFirefox=function(){var a=f.$el.position().left,b=f.$el.find("td:first").position().left;return b!==a},f.registerEditor=function(a){var b=new a(f);f.editors[b.name]=b},f.render=function(){f.renderBaseTable(),f.renderColumns(),f.renderData(),_.each(f.editors,function(a){a.initialize(),a.render(),a.getElement().hide()}),f.bindEvents()},f.destroy=function(){f.unbindEvents(),f.$el.remove()},f.bindEvents=function(){f.unbindEvents(),f.$el.on("click.grid","tr>td",f.clickCell),f.$el.on("dblclick.grid","tr>td",f.dblClickCell),f.$el.on("blur.grid",f.blur),f.$el.on("keydown.grid",f.keydown),f.$el.on("click.grid","tr>th.sensei-grid-sortable",f.sort),a(document).on("click.grid",f.editorBlur)},f.unbindEvents=function(){f.$el.off(".grid"),a(document).off(".grid")},f.sort=function(){var b=a(this).text(),c="asc";f.$el.find("th.sensei-grid-sortable .glyphicon").remove(),a(this).data("order")&&"asc"===a(this).data("order")?(c="desc",a(this).append(a("<span>").addClass("glyphicon glyphicon-chevron-up"))):a(this).append(a("<span>").addClass("glyphicon glyphicon-chevron-down")),a(this).data("order",c),f.events.trigger("column:sort",b,c,a(this)),f.renderData()},f.editorBlur=function(b){f.getActiveCell().length>0&&0===f.$el.has(a(b.target)).length&&(f.exitEditor(),f.deactivateCell())},f.hideEditors=function(){a(".sensei-grid-editor",f.$el).hide()},f.blur=function(){if(f.getActiveCell().length>0&&!f.isEditing){var a=f.getActiveCell();f.exitEditor(),f.isEditing=!1,f.deactivateCell(),e(a.parent("tr"))}},f.parsers={},f.parsers.string=function(a){return a.toString()},f.parsers["int"]=function(a){return parseInt(a)},f.parsers["float"]=function(a){return parseFloat(a)},f.getCellData=function(a){var b=a.text(),c=f.getCellType(a);return _.has(f.parsers,c)&&(b=f.parsers[c](b)),b},f.getCellColumn=function(a){return a.data("column")},f.getCellType=function(a){return a.data("type")},f.getCellStatus=function(a){return!!a.data("saved")},f.getCellDataByIndex=function(a,b){var c=f.getRowByIndex(a),d=f.getCellFromRowByIndex(c,b);return f.getCellData(d)},f.getCellDataByKey=function(a,b){var c=f.getRowByIndex(a),d=f.getCellFromRowByKey(c,b);return f.getCellData(d)},f.getCellFromRowByIndex=function(a,b){var c=a.find("td").eq(b);if(0===c.length)throw new Error("Cell does not exist");return c},f.getCellFromRowByKey=function(b,c){var d=b.find("td").filter(function(){return a(this).data("column")===c});if(0===d.length)throw new Error("Cell does not exist");return d},f.getRowCellsByIndex=function(a){return f.getRowByIndex(a).find("td")},f.getRowCells=function(a){return a.find("td")},f.getRowByIndex=function(a){var b=f.$el.find("tbody>tr").eq(a);if(0===b.length)throw new Error("Row does not exist");return b},f.getRowDataByIndex=function(a){var b=f.getRowByIndex(a);return f.getRowData(b)},f.getRowData=function(b){var c=f.getRowCells(b),d={};return c.each(function(){d[f.getCellColumn(a(this))]=f.getCellData(a(this))}),d},f.getRows=function(){return f.$el.find("tbody>tr")},f.getGridData=function(){var b=f.getRows();return b.map(function(){return f.getRowData(a(this))}).get()},f.getActiveCell=function(){return f.isEditing&&f.activeEditor&&f.activeEditor.activeCell?f.activeEditor.activeCell:a("td.activeCell",f.$el)},f.setRowSaved=function(a){a.removeClass("sensei-grid-dirty-row").removeClass("sensei-grid-empty-row"),a.find(">td").data("saved",!0)},f.deactivateCell=function(){var a=f.getActiveCell();a.removeClass("activeCell"),a.parent("tr").removeClass("activeRow"),f.events.trigger("cell:deactivate",a)},f.clearActiveCell=function(){var b=f.getActiveCell(),c=f.getCellData(b);a(">div",b).empty(),f.events.trigger("cell:clear",c,b)},f.moveRight=function(){var b=f.getActiveCell();if(b.next().length>0)b.next().setActiveCell();else{var c=b.parent("tr").next();c.length>0&&a("td:first",c).setActiveCell()}},f.moveUp=function(){var b=f.getActiveCell(),c=b.parent("tr").prev();if(c.length>0){var d=b.index(),e=a("td",c).eq(d);e.length>0?e.setActiveCell():a("td:last",c).setActiveCell()}},f.moveLeft=function(){var b=f.getActiveCell();if(b.prev().length>0)b.prev().setActiveCell();else{var c=b.parent("tr").prev();c.length>0&&a("td:last",c).setActiveCell()}},f.moveDown=function(){var b=f.getActiveCell(),c=b.parent("tr").next();if(c.length>0){var d=b.index(),e=a("td",c).eq(d);e.length>0?e.setActiveCell():a("td:first",c).setActiveCell()}},f.move=function(a){var b="move"+a.charAt(0).toUpperCase()+a.substr(1);_.has(f,b)?(f[b](),f.isEditing&&f.saveEditor(),f.isEditing&&f.editCell(),f.getActiveCell().find(">div").isOnScreen()||f.getActiveCell().get(0).scrollIntoView(_.contains(["up","left"],a)?!0:!1)):console.warn("move method not found",b)},f.editCell=function(){f.showEditor()},f.getEditor=function(){return f.activeEditor},f.getEditorInstance=function(){var a=f.getActiveCell(),b=a.data("editor");if(b&&_.has(f.editors,b))return f.editors[b];throw Error("Editor not found: "+b)},f.saveEditor=function(){if(f.isEditing){var b=f.getActiveCell(),c=f.activeEditor.getValue();if(c!==b.text()){b.html(a("<div>").text(c));var d={};d[b.data("column")]=c,f.events.trigger("editor:save",d,b);var e=b.parent("tr");e.hasClass("sensei-grid-empty-row")&&(e.removeClass("sensei-grid-empty-row").addClass("sensei-grid-dirty-row"),f.assureEmptyRow())}}f.getEditor().hide()},f.assureEmptyRow=function(){if(f.config.emptyRow&&0===f.$el.find("table>tbody>tr.sensei-grid-empty-row").length){var a=f.$el.find("table>tbody"),b=f.renderRow(null,!1);a.append(b)}},f.exitEditor=function(a){var b=f.getActiveCell();if(f.isEditing&&f.activeEditor)if(a)f.getEditor().hide();else{f.saveEditor();var c=b.parent("tr");c.hasClass("sensei-grid-dirty-row")&&f.isEditing&&f.events.trigger("row:save",f.getRowData(c),c,"editor:close")}f.isEditing&&(b.setActiveCell(),f.$el.focus()),f.isEditing=!1},f.moveEditor=function(){f.isEditing&&(f.showEditor(),f.editCell())},f.showEditor=function(){f.activeEditor=f.getEditorInstance();var a=f.activeEditor.getElement(),b=f.getActiveCell();f.activeEditor.activeCell=b,f.isEditing=!0,a.show(),a.css(b.cellPosition()),a.css({width:b.outerWidth()+1,height:b.outerHeight()+1});var c=b.data("column"),d=b.text();f.activeEditor.setValue(d);var e={};return e[c]=d,f.events.trigger("editor:load",e,b),a},f.keydown=function(a){var b=!0,c=[8,9,13,27,37,38,39,40],d=[8,37,38,39,40];if(!(0===f.getActiveCell().length&&!f.isEditing||!_.contains(c,a.which)||f.isEditing&&_.contains(d,a.which))){switch(a.preventDefault(),a.which){case 37:f.move("left");break;case 38:f.move("up");break;case 39:f.move("right");break;case 40:f.move("down");break;case 13:f.isEditing?a.ctrlKey&&a.shiftKey?f.move("up"):a.ctrlKey&&!a.shiftKey?f.move("down"):f.exitEditor():f.editCell();break;case 27:f.isEditing?f.exitEditor(!0):f.$el.blur();break;case 9:f.move(a.shiftKey?"left":"right");break;case 8:f.clearActiveCell()}b&&a.preventDefault()}},f.clickCell=function(b){b.preventDefault(),f.isEditing&&f.exitEditor(),a(this).setActiveCell()},f.dblClickCell=function(b){b.preventDefault(),a(this).setActiveCell(),f.editCell()},f.renderColumns=function(){var b=a("thead",f.$el),c=document.createElement("tr");_.each(f.columns,function(b){var d=document.createElement("th"),e=document.createElement("div");f.config.sortable&&(d.className="sensei-grid-sortable"),a(e).text(b.name),d.appendChild(e),a(d).data("type",b.type||"string"),a(d).data("editor",b.editor||"BasicEditor"),c.appendChild(d)}),b.append(c)},f.renderData=function(){var b=a("tbody",f.$el);if(b.html(null),_.each(f.data,function(a){var c=f.renderRow(a,!0);b.append(c)}),f.config.emptyRow){var c=f.renderRow(null,!1);b.append(c)}},f.renderRow=function(b,c){var d=document.createElement("tr");return c||(d.className="sensei-grid-empty-row"),_.each(f.columns,function(e){var f=document.createElement("td"),g=document.createElement("div");_.has(b,e.name)&&a(g).text(b[e.name]),a(f).data("column",e.name),a(f).data("type",e.type||"string"),a(f).data("editor",e.editor||"BasicEditor"),a(f).data("saved",c),f.appendChild(g),d.appendChild(f)}),d},f.renderBaseTable=function(){var a=document.createElement("table"),b=document.createElement("thead"),c=document.createElement("tbody");a.appendChild(b),a.appendChild(c),a.className=f.config.tableClass,f.$el.html(a),f.$el.attr("tabindex",-1)},f.init=function(b,c,d){return f.config=a.extend({},g,d),f.data=b,f.columns=c,f.$el=a(this),f.editors={},f},f.init(b,c,d)}}(jQuery),function(a){var b=this,c=function(a){this.grid=a};c.extend=function(a){var b,c=this;b=function(){return c.apply(this,arguments)};var d=function(){this.constructor=b};return d.prototype=c.prototype,b.prototype=new d,a&&_.extend(b.prototype,a),b.__super__=c.prototype,b},c.prototype.getElement=function(){return a(this.editor)},c.prototype.initialize=function(){},c.prototype.render=function(){},c.prototype.show=function(){this.getElement().show()},c.prototype.hide=function(){this.getElement().hide(),this.grid.activeEditor.activeCell=null,this.grid.activeEditor=null},c.prototype.getValue=function(){throw Error("Editor.getValue not implemented")},c.prototype.setValue=function(){throw Error("Editor.setValue not implemented")},b.Editor=c,b.BasicEditor=c.extend({types:[],name:"BasicEditor",render:function(){if(!this.editor){this.editor=document.createElement("div"),this.editor.className="sensei-grid-editor sensei-grid-basic-editor";var a=document.createElement("input");this.editor.appendChild(a),this.grid.$el.append(this.editor)}},getValue:function(){return a("input",this.editor).val()},setValue:function(b){a("input",this.editor).val(b).focus()}})}(jQuery);